{% extends "base.html" %}

{% block title %}
ksqlDB UI - {% trans %}Topology{% endtrans %} - {{ current_server.display_name }}
{% endblock %}

{% block css %}
<link rel="stylesheet" href="/static/css/stream.css">
<link rel="stylesheet" href="/static/css/topology.css">
{% endblock %}

{% block body %}
<div class="my-container">
  <h2 class="title-h2">
    {% trans name=current_server.display_name %}Topology for {{ name }}{% endtrans %}
  </h2>

  <div>
    <div class="filter-group">
      <div class="filter-item active" data-name="streams" onclick="renderStreamsQuery(this);">
        {% trans %}Streams/query{% endtrans %}
      </div>
      <div class="filter-item" data-name="topics" onclick="renderTopics(this);">
        {% trans %}Topics{% endtrans %}
      </div>
    </div>
  </div>

  <!-- Hidden data -->
  {% for stream in streams %}
  <div class="topology stream" data-name="{{stream.name}}" data-topic="{{stream.topic}}"></div>
  {% for query in stream["readQueries"] %}
  {% for sink in query["sinks"] %}
  <div class="topology query" data-name="{{query.id}}" data-state="{{query.state}}" data-source="{{stream.name}}"
    data-sink="{{sink}}"></div>
  {% endfor %}
  {% endfor %}
  {% endfor %}

  <!-- SVG -->
  <div id="svg-parent"></div>

  <!-- Original response -->
  {% include "includes/hidden_response_details.html" %}
</div>
{% endblock %}

{% block js %}
{{ super() }}
<script src="/static/vendor/d3/d3.min.js"></script>
<script src="/static/vendor/d3/dagre-d3.min.js"></script>
<script src="/static/js/stream.js"></script>
<script src="/static/js/topology.js"></script>
<script>
  let globalGraph = null;

  function updateTab(tabName) {
    document.querySelectorAll('.filter-item').forEach(function (el) {
      el.classList.remove('active');
    });
    document.querySelector(`.filter-item[data-name="${tabName}"]`).classList.add('active');
  }

  function updateTopologyQueryParam(value) {
    const url = new URL(window.location);
    url.searchParams.set('view', value);
    window.history.replaceState({}, '', url);
  }

  function renderStreamsQuery(tabElement) {
    updateTab("streams");
    updateTopologyQueryParam("streams");

    globalGraph = buildTopology("{{q}}");
    renderGraph(globalGraph);
  }

  function renderTopics(tabElement) {
    updateTab("topics");
    updateTopologyQueryParam("topics");

    globalGraph = buildTopicsTopology("{{q}}");
    renderGraph(globalGraph);
  }

  document.addEventListener("DOMContentLoaded", function () {
    // Load global topology
    initSvgCanvas();

    // Check URL parameter to determine which view to render
    const urlParams = new URLSearchParams(window.location.search);
    const view = urlParams.get('view');
    if (view == 'topics') {
      renderTopics();
    } else {
      renderStreamsQuery();
    }

    // Init all tooltips
    $('[data-toggle="tooltip"]').tooltip()
  });

  window.addEventListener('resize', function () {
    renderGraph(globalGraph);
  });
</script>
{% endblock %}
